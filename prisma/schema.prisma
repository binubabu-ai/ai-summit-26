generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String             @id
  email             String             @unique
  name              String?
  avatar            String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  auditLogs         AuditLog[]
  approvals         DocumentApproval[]
  groundedDocuments Document[]         @relation("DocumentGrounder")
  ownedDocuments    Document[]         @relation("DocumentOwner")
  createdLinks      FeatureDocLink[]
  invitedMembers    ProjectMember[]    @relation("InvitedBy")
  members           ProjectMember[]
  projects          Project[]
  revisions         Revision[]
  versions          Version[]

  @@map("users")
}

model Project {
  id        String          @id @default(cuid())
  name      String
  slug      String          @unique
  ownerId   String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  apiKeys   ApiKey[]
  docs      Document[]
  members   ProjectMember[]
  owner     User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  proposals Proposal[]

  @@index([slug])
  @@index([ownerId])
  @@map("projects")
}

model ApiKey {
  id           String    @id @default(cuid())
  projectId    String
  name         String
  key          String    @unique
  keyPrefix    String
  lastUsedAt   DateTime?
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  requestCount Int       @default(0)
  lastUsedFrom String?
  permissions  Json?
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([key])
  @@index([isActive])
  @@index([createdAt])
  @@map("api_keys")
}

model ProjectMember {
  id           String    @id @default(cuid())
  projectId    String
  userId       String
  role         String    @default("VIEWER")
  createdAt    DateTime  @default(now())
  invitedBy    String?
  lastAccessAt DateTime?
  inviter      User?     @relation("InvitedBy", fields: [invitedBy], references: [id])
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([invitedBy])
  @@map("project_members")
}

model Document {
  id                 String              @id @default(cuid())
  path               String
  projectId          String
  content            String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  confidenceScore    Float               @default(0.5)
  freshnessScore     Float               @default(1.0)
  hasAmbiguity       Boolean             @default(false)
  hasConflicts       Boolean             @default(false)
  hasMissingSections Boolean             @default(false)
  lastAnalyzedAt     DateTime?
  lastVerifiedAt     DateTime?
  riskScore          Float               @default(0.0)
  mainRevisionId     String?             @unique
  archivedAt         DateTime?
  deprecatedAt       DateTime?
  deprecationReason  String?
  editorialState     String              @default("draft")
  expiresAt          DateTime?
  groundedAt         DateTime?
  groundingState     String              @default("ungrounded")
  lastReviewedAt     DateTime?
  nextReviewDue      DateTime?
  processedAt        DateTime?
  processingError    String?
  publishedAt        DateTime?
  ttlDays            Int?
  uploadState        String              @default("ready")
  uploadedAt         DateTime?
  category           String?
  constraintLevel    ConstraintLevel     @default(SOFT)
  docType            DocumentType        @default(GENERAL)
  groundedBy         String?
  groundedReason     String?
  lastReferencedAt   DateTime?
  nextReviewDate     DateTime?
  owner              String?
  referenceCount     Int                 @default(0)
  relatedFeatures    String[]            @default([])
  reviewSchedule     ReviewSchedule      @default(NEVER)
  tags               String[]            @default([])
  generatedBy        String?
  generationPrompt   String?
  sourceDocumentId   String?
  templateUsed       String?
  alerts             Alert[]
  analyses           Analysis[]
  chatMessages       ChatMessage[]
  conflicts          Conflict[]
  decisionRecords    DecisionRecord[]
  approvals          DocumentApproval[]
  modules            DocumentModule[]
  grounderUser       User?               @relation("DocumentGrounder", fields: [groundedBy], references: [id])
  mainRevision       Revision?           @relation("MainRevision", fields: [mainRevisionId], references: [id])
  ownerUser          User?               @relation("DocumentOwner", fields: [owner], references: [id])
  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceDocument     Document?           @relation("GeneratedFrom", fields: [sourceDocumentId], references: [id])
  generatedDocs      Document[]          @relation("GeneratedFrom")
  embeddings         Embedding[]
  featureLinks       FeatureDocLink[]
  groundingSnapshots GroundingSnapshot[]
  revisions          Revision[]
  suggestions        Suggestion[]
  versions           Version[]

  @@unique([projectId, path])
  @@index([projectId])
  @@index([path])
  @@index([mainRevisionId])
  @@index([freshnessScore])
  @@index([riskScore])
  @@index([lastAnalyzedAt])
  @@index([uploadState])
  @@index([groundingState])
  @@index([editorialState])
  @@index([expiresAt])
  @@index([nextReviewDue])
  @@index([docType])
  @@index([constraintLevel])
  @@index([category])
  @@index([owner])
  @@index([reviewSchedule])
  @@index([lastReferencedAt])
  @@index([nextReviewDate])
  @@index([sourceDocumentId])
  @@index([generatedBy])
  @@index([templateUsed])
  @@map("documents")
}

model Proposal {
  id              String    @id @default(cuid())
  title           String
  description     String?
  branchName      String    @unique
  status          String    @default("OPEN")
  projectId       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  aiGenerated     Boolean   @default(false)
  changeRationale String    @default("")
  conflictCheck   Json?
  reviewComments  Json?
  riskAssessment  Json?
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  changes         Version[]

  @@index([projectId])
  @@index([status])
  @@index([branchName])
  @@map("proposals")
}

model Version {
  id              String    @id @default(cuid())
  content         String
  docId           String
  proposalId      String?
  authorId        String?
  authorType      String    @default("user")
  createdAt       DateTime  @default(now())
  aiGenerated     Boolean   @default(false)
  approvedAt      DateTime?
  approvedBy      String?
  changeRationale String?
  changeType      String?
  reviewRequired  Boolean   @default(true)
  author          User?     @relation(fields: [authorId], references: [id])
  document        Document  @relation(fields: [docId], references: [id], onDelete: Cascade)
  proposal        Proposal? @relation(fields: [proposalId], references: [id])

  @@index([docId])
  @@index([proposalId])
  @@index([authorId])
  @@index([createdAt])
  @@map("versions")
}

model Revision {
  id                 String         @id @default(cuid())
  documentId         String
  content            String
  title              String
  description        String?
  status             String         @default("draft")
  isMain             Boolean        @default(false)
  basedOn            String?
  replacedRevisionId String?
  authorId           String?
  authorType         String         @default("ai")
  sourceClient       String?
  sourceSessionId    String?
  createdAt          DateTime       @default(now())
  proposedAt         DateTime?
  approvedAt         DateTime?
  approvedBy         String?
  rejectedAt         DateTime?
  rejectedBy         String?
  hasConflicts       Boolean        @default(false)
  conflictReason     String?
  mainFor            Document?      @relation("MainRevision")
  diffs              RevisionDiff[]
  author             User?          @relation(fields: [authorId], references: [id])
  document           Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([status])
  @@index([isMain])
  @@index([basedOn])
  @@index([authorId])
  @@index([createdAt])
  @@index([proposedAt])
  @@map("revisions")
}

model RevisionDiff {
  id         String   @id @default(cuid())
  revisionId String
  diffType   String
  diffData   Json
  stats      Json
  createdAt  DateTime @default(now())
  revision   Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

  @@unique([revisionId, diffType])
  @@index([revisionId])
  @@map("revision_diffs")
}

model Conflict {
  id                  String    @id @default(cuid())
  documentId          String
  conflictType        String
  severity            String
  description         String
  location            Json
  conflictingDocId    String?
  conflictingLocation Json?
  status              String    @default("open")
  detectedBy          String
  detectedAt          DateTime  @default(now())
  resolvedAt          DateTime?
  resolvedBy          String?
  resolvedComment     String?
  document            Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([status])
  @@index([severity])
  @@index([conflictType])
  @@index([detectedAt])
  @@map("conflicts")
}

model Analysis {
  id              String   @id @default(cuid())
  documentId      String
  analysisType    String
  result          Json
  score           Float
  recommendations Json?
  analyzedAt      DateTime @default(now())
  llmModel        String
  llmCost         Float?
  tokenCount      Int?
  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([analysisType])
  @@index([analyzedAt])
  @@index([score])
  @@map("analyses")
}

model Embedding {
  id         String   @id @default(cuid())
  documentId String
  chunkIndex Int
  chunkText  String
  embedding  String
  createdAt  DateTime @default(now())
  model      String   @default("text-embedding-3-small")
  dimensions Int      @default(1536)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([documentId])
  @@map("embeddings")
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  actorId    String?
  actorType  String
  changes    Json
  metadata   Json?
  createdAt  DateTime @default(now())
  actor      User?    @relation(fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model ChatMessage {
  id          String   @id @default(cuid())
  documentId  String
  role        String
  content     String
  suggestions Json?
  createdAt   DateTime @default(now())
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([createdAt])
  @@map("chat_messages")
}

model Suggestion {
  id            String    @id @default(cuid())
  documentId    String
  chatMessageId String?
  type          String
  title         String
  description   String
  originalText  String
  suggestedText String
  reasoning     String
  confidence    Float     @default(0.8)
  status        String    @default("pending")
  appliedAt     DateTime?
  rejectedAt    DateTime?
  createdAt     DateTime  @default(now())
  document      Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([status])
  @@index([createdAt])
  @@map("suggestions")
}

model AiUsage {
  id           String   @id @default(cuid())
  userId       String?
  projectId    String?
  documentId   String?
  operation    String
  model        String
  inputTokens  Int
  outputTokens Int
  cost         Float
  latency      Int?
  success      Boolean  @default(true)
  errorMessage String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([documentId])
  @@index([operation])
  @@index([createdAt])
  @@map("ai_usage")
}

model Audit {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  auditType        String
  targetId         String?
  userId           String
  healthScore      Int
  consistencyScore Int?
  freshnessScore   Int?
  qualityScore     Int?
  findings         Json
  duration         Int
  aiModel          String
  cost             Float

  @@index([auditType])
  @@index([targetId])
  @@index([userId])
  @@index([createdAt])
  @@map("audits")
}

model DocumentModule {
  id               String                   @id @default(cuid())
  documentId       String
  moduleKey        String
  title            String
  description      String?
  order            Int                      @default(0)
  content          String
  contentHash      String
  startLine        Int?
  endLine          Int?
  headingLevel     Int?
  isGrounded       Boolean                  @default(false)
  groundedAt       DateTime?
  groundingSource  String?
  confidenceScore  Float                    @default(0.5)
  moduleType       String                   @default("section")
  tags             Json?
  dependsOn        String[]                 @default([])
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  lastGroundedAt   DateTime?
  category         String?
  clarityScore     Float                    @default(0.5)
  concepts         String[]                 @default([])
  dependencies     String[]                 @default([])
  entities         String[]                 @default([])
  moduleTags       String[]                 @default([])
  qualityScore     Float                    @default(0.5)
  document         Document                 @relation(fields: [documentId], references: [id], onDelete: Cascade)
  conflicts        ModuleConflict[]
  groundingHistory ModuleGroundingHistory[]

  @@unique([documentId, moduleKey])
  @@index([documentId])
  @@index([isGrounded])
  @@index([moduleType])
  @@index([groundedAt])
  @@index([category])
  @@map("document_modules")
}

model ModuleConflict {
  id                  String          @id @default(cuid())
  moduleId            String
  conflictType        String
  severity            String
  description         String
  conflictingModuleId String?
  conflictingDocId    String?
  conflictingLocation Json?
  status              String          @default("open")
  detectedBy          String
  detectedAt          DateTime        @default(now())
  resolvedAt          DateTime?
  resolvedBy          String?
  resolutionNote      String?
  affectedFeatures    String[]        @default([])
  resolutionDiff      Json?
  resolutionType      ResolutionType?
  systemicType        SystemicType?
  module              DocumentModule  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([status])
  @@index([severity])
  @@index([conflictType])
  @@index([systemicType])
  @@index([resolutionType])
  @@map("module_conflicts")
}

model GroundingSnapshot {
  id               String    @id @default(cuid())
  projectId        String
  documentId       String?
  snapshotName     String
  description      String?
  groundingContext Json
  scope            String    @default("project")
  scopeIdentifier  String?
  version          String
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  createdBy        String?
  expiresAt        DateTime?
  documentCount    Int       @default(0)
  moduleCount      Int       @default(0)
  totalSize        Int       @default(0)
  document         Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([documentId])
  @@index([isActive])
  @@index([version])
  @@index([createdAt])
  @@map("grounding_snapshots")
}

model ModuleGroundingHistory {
  id              String         @id @default(cuid())
  moduleId        String
  action          String
  previousState   String?
  newState        String
  reason          String
  source          String
  triggeredBy     String?
  contentBefore   String?
  contentAfter    String
  diffSummary     Json?
  confidenceScore Float?
  metadata        Json?
  occurredAt      DateTime       @default(now())
  module          DocumentModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([action])
  @@index([occurredAt])
  @@map("module_grounding_history")
}

model DocumentProcessingJob {
  id             String    @id @default(cuid())
  documentId     String
  jobType        String
  priority       Int       @default(5)
  status         String    @default("pending")
  startedAt      DateTime?
  completedAt    DateTime?
  processingTime Int?
  result         Json?
  error          String?
  retryCount     Int       @default(0)
  maxRetries     Int       @default(3)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([documentId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("document_processing_jobs")
}

model DocumentApproval {
  id           String         @id @default(cuid())
  documentId   String
  approver     String
  action       ApprovalAction
  comment      String?
  metadata     Json?
  createdAt    DateTime       @default(now())
  approverUser User           @relation(fields: [approver], references: [id], onDelete: Cascade)
  document     Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([approver])
  @@index([action])
  @@index([createdAt])
  @@map("document_approvals")
}

model FeatureDocLink {
  id             String    @id @default(cuid())
  projectId      String
  featureSlug    String
  documentId     String
  linkType       LinkType
  reason         String?
  createdBy      String?
  createdAt      DateTime  @default(now())
  lastVerifiedAt DateTime?
  creator        User?     @relation(fields: [createdBy], references: [id])
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([featureSlug, documentId, linkType])
  @@index([featureSlug])
  @@index([documentId])
  @@index([projectId])
  @@index([linkType])
  @@map("feature_doc_links")
}

model DecisionRecord {
  id                 String         @id @default(cuid())
  projectId          String
  title              String
  description        String
  context            String
  decision           String
  consequences       String
  decisionType       String
  status             DecisionStatus @default(PROPOSED)
  source             DecisionSource
  sourceUrl          String?
  extractedFrom      String?
  extractedAt        DateTime       @default(now())
  extractedBy        String?
  documentId         String?
  suggestedDocPath   String?
  supersedes         String[]       @default([])
  supersededBy       String?
  relatedDecisions   String[]       @default([])
  tags               String[]       @default([])
  affectedComponents String[]       @default([])
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  document           Document?      @relation(fields: [documentId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([source])
  @@index([decisionType])
  @@index([extractedAt])
  @@map("decision_records")
}

model ConceptRegistry {
  id               String        @id @default(cuid())
  projectId        String
  term             String
  definition       String
  aliases          String[]      @default([])
  category         String?
  domain           String?
  firstSeenIn      String?
  definitionSource String?
  extractedAt      DateTime      @default(now())
  status           ConceptStatus @default(ACTIVE)
  confidence       Float         @default(0.8)
  relatedConcepts  String[]      @default([])
  usedInDocuments  String[]      @default([])
  examples         Json?
  references       Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([projectId, term])
  @@index([projectId])
  @@index([category])
  @@index([status])
  @@index([term])
  @@map("concept_registry")
}

model Alert {
  id             String        @id @default(cuid())
  projectId      String
  documentId     String?
  moduleId       String?
  type           AlertType
  severity       AlertSeverity
  title          String
  message        String
  metadata       Json?
  status         AlertStatus   @default(ACTIVE)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedBy     String?
  resolvedAt     DateTime?
  resolutionNote String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  expiresAt      DateTime?
  document       Document?     @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([documentId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("alerts")
}

enum DocumentType {
  ARCHITECTURE
  API_CONTRACT
  DOMAIN_MODEL
  SECURITY
  FEATURE_SPEC
  RUNBOOK
  GENERAL
}

enum ConstraintLevel {
  HARD
  SOFT
  INFO
}

enum ReviewSchedule {
  NEVER
  MONTHLY
  QUARTERLY
  BIANNUAL
  ANNUAL
}

enum ApprovalAction {
  APPROVED
  REJECTED
  REQUESTED_CHANGES
  REVIEWED
  DEPRECATED
}

enum LinkType {
  IMPLEMENTS
  REFERENCES
  CONSTRAINS
  DOCUMENTS
}

enum SystemicType {
  NAMING_INCONSISTENCY
  VERSIONING_CONFLICT
  SCOPE_OVERLAP
  DEPENDENCY_CIRCULAR
  ARCHITECTURE_DRIFT
}

enum ResolutionType {
  MERGED
  PRIORITIZED
  SPLIT
  DEPRECATED
  REWRITTEN
}

enum DecisionStatus {
  PROPOSED
  ACCEPTED
  REJECTED
  DEPRECATED
  SUPERSEDED
}

enum DecisionSource {
  PR
  COMMIT
  DOCUMENT
  MEETING
  MANUAL
}

enum ConceptStatus {
  ACTIVE
  DEPRECATED
  AMBIGUOUS
  CLARIFICATION_NEEDED
}

enum AlertType {
  STALE_DOCUMENT
  MISSING_REVIEW
  HARD_CONSTRAINT_VIOLATION
  CONFLICT_DETECTED
  ORPHANED_DOCUMENT
  DEPRECATED_USAGE
  MISSING_OWNER
  LOW_QUALITY
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
  EXPIRED
}
